MODx.page.CreateResource=function(config){config=config||{};Ext.applyIf(config,{url:MODx.config.connector_url,formpanel:'modx-panel-resource',id:'modx-page-update-resource',which_editor:'none',action:'resource/create',buttons:this.getButtons(config),components:[{xtype:config.panelXType||'modx-panel-resource',renderTo:config.panelRenderTo||'modx-panel-resource-div',resource:0,record:config.record,publish_document:config.publish_document,show_tvs:config.show_tvs,mode:config.mode,url:config.url}]});MODx.page.CreateResource.superclass.constructor.call(this,config);};Ext.extend(MODx.page.CreateResource,MODx.Component,{getButtons:function(cfg){var btns=[];if(cfg.canSave==1){btns.push({process:'resource/create',reload:true,text:_('save'),id:'modx-abtn-save',cls:'primary-button',method:'remote',keys:[{key:MODx.config.keymap_save||'s',ctrl:true}]});}
btns.push({text:_('cancel'),id:'modx-abtn-cancel'});btns.push({text:_('help_ex'),id:'modx-abtn-help',handler:MODx.loadHelpPane});return btns;}});Ext.reg('modx-page-resource-create',MODx.page.CreateResource);;Ext.Spotlight=function(config){Ext.apply(this,config);}
Ext.Spotlight.prototype={active:false,animate:true,animated:false,duration:.25,easing:'easeNone',createElements:function(){var bd=Ext.getBody();this.right=bd.createChild({cls:'x-spotlight'});this.left=bd.createChild({cls:'x-spotlight'});this.top=bd.createChild({cls:'x-spotlight'});this.bottom=bd.createChild({cls:'x-spotlight'});this.all=new Ext.CompositeElement([this.right,this.left,this.top,this.bottom]);},show:function(el,callback,scope){if(this.animated){this.show.defer(50,this,[el,callback,scope]);return;}
this.el=Ext.get(el);if(!this.right){this.createElements();}
if(!this.active){this.all.setDisplayed('');this.applyBounds(true,false);this.active=true;Ext.EventManager.onWindowResize(this.syncSize,this);this.applyBounds(false,this.animate,false,callback,scope);}else{this.applyBounds(false,false,false,callback,scope);}},hide:function(callback,scope){if(this.animated){this.hide.defer(50,this,[callback,scope]);return;}
Ext.EventManager.removeResizeListener(this.syncSize,this);this.applyBounds(true,this.animate,true,callback,scope);},doHide:function(){this.active=false;this.all.setDisplayed(false);},syncSize:function(){this.applyBounds(false,false);},applyBounds:function(basePts,anim,doHide,callback,scope){var rg=this.el.getRegion();var dw=Ext.lib.Dom.getViewWidth(true);var dh=Ext.lib.Dom.getViewHeight(true);var c=0,cb=false;if(anim){cb={callback:function(){c++;if(c==4){this.animated=false;if(doHide){this.doHide();}
Ext.callback(callback,scope,[this]);}},scope:this,duration:this.duration,easing:this.easing};this.animated=true;}
this.right.setBounds(rg.right,basePts?dh:rg.top,dw-rg.right,basePts?0:(dh-rg.top),cb);this.left.setBounds(0,0,rg.left,basePts?0:rg.bottom,cb);this.top.setBounds(basePts?dw:rg.left,0,basePts?0:dw-rg.left,rg.top,cb);this.bottom.setBounds(0,rg.bottom,basePts?0:rg.right,dh-rg.bottom,cb);if(!anim){if(doHide){this.doHide();}
if(callback){Ext.callback(callback,scope,[this]);}}},destroy:function(){this.doHide();Ext.destroy(this.right,this.left,this.top,this.bottom);delete this.el;delete this.all;}};;GAL.view.AlbumItems=function(config){config=config||{};this._initTemplates();Ext.applyIf(config,{url:GAL.config.connector_url,fields:['id','album','name','description','mediatype','url','createdon','createdby','filename','filesize','thumbnail','image','image_width','image_height','tags','active','rank','absoluteImage','relativeImage','menu'],ident:'galbit',id:'gal-album-items-view',baseParams:{action:'mgr/item/getList',album:config.album},loadingText:_('loading'),tpl:this.templates.thumb,enableDD:true,multiSelect:true,itemSelector:'div.modx-browser-thumb-wrap',listeners:{'selectionchange':{fn:this.showDetails,scope:this,buffer:100},'dblclick':config.onSelect||{fn:Ext.emptyFn,scope:this}},prepareData:this.formatData.createDelegate(this)});GAL.view.AlbumItems.superclass.constructor.call(this,config);this.on('selectionchange',this.showDetails,this,{buffer:100});this.addEvents('sort','select');this.on('sort',this.onSort,this);this.on('dblclick',this.onDblClick,this);};Ext.extend(GAL.view.AlbumItems,MODx.DataView,{templates:{},windows:{},onSort:function(o){MODx.Ajax.request({url:this.config.url,params:{action:'mgr/item/sort',album:this.config.album,source:o.source.id,target:o.target.id}});},onDblClick:function(d,idx,n){var node=this.getSelectedNodes()[0];if(!node)return false;if(this.config.inPanel){this.cm.activeNode=node;this.updateItem(node,n);}else{var data=this.lookup[node.id];this.fireEvent('select',data);}},updateItem:function(btn,e){var node=this.cm.activeNode;var data=this.lookup[node.id];if(!data)return false;this.windows.updateItem=MODx.load({xtype:'gal-window-item-update',listeners:{'success':{fn:function(){this.store.reload();},scope:this}}});this.windows.updateItem.setValues(data);this.windows.updateItem.show(e.target);},setAsCover:function(btn,e){var node=this.cm.activeNode;var data=this.lookup[node.id];if(!data)return false;MODx.Ajax.request({url:this.config.url,params:{action:'mgr/album/setCoverItem',id:data.id,albumid:data.album},listeners:{'success':{fn:function(r){var panel=Ext.getCmp('gal-panel-album');panel.getForm().setValues(r.object);},scope:this}}});},deleteItem:function(btn,e){var node=this.cm.activeNode;var data=this.lookup[node.id];if(!data)return false;MODx.msg.confirm({text:_('gallery.item_delete_confirm'),url:this.config.url,params:{action:'mgr/item/remove',id:data.id},listeners:{'success':{fn:function(r){this.store.reload();},scope:this}}});},deleteMultiple:function(btn,e){var recs=this.getSelectedRecords();if(!recs)return false;var ids='';for(var i=0;i<recs.length;i++){ids+=','+recs[i].id;}
MODx.msg.confirm({text:_('gallery.item_delete_multiple_confirm'),url:this.config.url,params:{action:'mgr/item/removeMultiple',ids:ids.substr(1)},listeners:{'success':{fn:function(r){this.store.reload();},scope:this}}});return true;},run:function(p){p=p||{};var v={};Ext.apply(v,this.store.baseParams);Ext.apply(v,p);this.pagingBar.changePage(1);this.store.baseParams=v;this.store.load();},sortBy:function(sel){this.store.baseParams.sorter=sel.getValue();this.store.reload();return true;},sortDir:function(sel){this.store.baseParams.dir=sel.getValue();this.store.reload();},showDetails:function(){var selNode=this.getSelectedNodes();var detailEl=Ext.getCmp('gal-album-items-detail').body;if(selNode&&selNode.length>0){selNode=selNode[0];var data=this.lookup[selNode.id];if(data){detailEl.hide();this.templates.details.overwrite(detailEl,data);detailEl.slideIn('l',{stopFx:true,duration:'.2'});}}else{detailEl.update('');}},formatData:function(data){var formatSize=function(data){if(data.size<1024){return data.size+' '+_('gallery.bytes');}else{return(Math.round(((data.size*10)/1024))/10)+" KB";}};data.shortName=Ext.util.Format.ellipsis(data.name,16);data.sizeString=formatSize(data);data.releasedon=new Date(data.releasedon).format("m/d/Y g:i a");this.lookup['gal-item-'+data.id]=data;return data;},_initTemplates:function(){this.templates.thumb=new Ext.XTemplate('<tpl for=".">','<div class="modx-browser-thumb-wrap modx-pb-thumb-wrap <tpl if="!active">gal-item-inactive</tpl>" id="gal-item-{id}">','<div class="modx-browser-thumb gal-item-thumb">','<img src="{thumbnail}" title="{name}" />','</div>','<span>{shortName}</span>','</div>','</tpl>');this.templates.thumb.compile();this.templates.details=new Ext.XTemplate('<div class="details">','<tpl for=".">','<div class="modx-browser-detail-thumb modx-pb-detail-thumb"><img src="{image}" alt="{shortName}" onclick="Ext.getCmp(\'gal-album-items-view\').showScreenshot(\'{id}\'); return false;" /></div>','<div class="modx-browser-details-info modx-pb-details-info">','<span class="gal-detail-active">','<tpl if="active"><span class="green">'+_('gallery.active')+'</span></tpl>','<tpl if="!active"><span class="red">'+_('gallery.inactive')+'</span></tpl>','</span>','<h4>{shortName}</h4><br />','<tpl if="description"><p>{description}</p><br /></tpl>','<b>'+_('id')+':</b><span>{id}</span>','<b>'+_('gallery.file_name')+':</b><span>{filename}</span>','<b>'+_('gallery.file_size')+':</b><span>{filesize}</span>','<tpl if="tags"><b>'+_('gallery.tags')+':</b><span>{tags}</span></tpl>','<tpl if="url"><b>'+_('gallery.item_url')+':</b><span>{url}</span></tpl>','</div>','</tpl>','</div>');this.templates.details.compile();},showScreenshot:function(id){var data=this.lookup['gal-item-'+id];if(!data)return false;if(!this.ssWin){this.ssWin=new Ext.Window({layout:'fit',width:600,height:450,closeAction:'hide',plain:true,items:[{id:'gal-item-ss',html:''}],buttons:[{text:_('close'),handler:function(){this.ssWin.hide();},scope:this}]});}
this.ssWin.show();this.ssWin.setSize(data.image_width,data.image_height);this.ssWin.center();this.ssWin.setTitle(data.name);Ext.get('gal-item-ss').update('<img src="'+data.image+'" alt="" onclick="Ext.getCmp(\'gal-album-items-view\').ssWin.hide();" />');},_showContextMenu:function(v,i,n,e){e.preventDefault();var data=this.lookup[n.id];var m=this.cm;m.removeAll();var ct=this.getSelectionCount();if(ct==1){m.add({text:_('gallery.item_update'),handler:this.updateItem,scope:this});m.add({text:_('gallery.set_as_cover'),handler:this.setAsCover,scope:this});m.add('-');m.add({text:_('gallery.item_delete'),handler:this.deleteItem,scope:this});m.show(n,'tl-c?');}else if(ct>1){m.add({text:_('gallery.item_delete_multiple'),handler:this.deleteMultiple,scope:this});m.show(n,'tl-c?');}
m.activeNode=n;}});Ext.reg('gal-view-album-items',GAL.view.AlbumItems);;GAL.tree.Album=function(config){config=config||{};Ext.applyIf(config,{id:'gal-tree-album',url:GAL.config.connector_url,action:'mgr/album/getNodes',tbar:[{text:_('gallery.album_create'),cls:'primary-button',handler:function(btn,e){this.createAlbum(btn,e,true);},scope:this},'-',{text:_('gallery.refresh'),handler:this.refresh,scope:this}],sortAction:'mgr/album/sort',rootVisible:false});GAL.tree.Album.superclass.constructor.call(this,config);};Ext.extend(GAL.tree.Album,MODx.tree.Tree,{windows:{},createAlbum:function(btn,e,b){b=b||false;var r;if(this.cm.activeNode&&!b){var n=this.cm.activeNode.attributes;r={'parent':n.pk,parent_name:n.name};}else{r={'parent':0,parent_name:_('none')};}
if(!this.windows.createAlbum){this.windows.createAlbum=MODx.load({xtype:'gal-window-album-create',record:r,listeners:{'success':{fn:function(){this.refresh();},scope:this}}});}
this.windows.createAlbum.fp.getForm().reset();this.windows.createAlbum.setValues(r);this.windows.createAlbum.show(e.target);},updateAlbum:function(btn,e){var id=this.cm.activeNode?this.cm.activeNode.attributes.pk:0;location.href='?a='+GAL.action+'&album='+id+'&action=album/update';},removeAlbum:function(btn,e){if(!this.cm.activeNode)return false;MODx.msg.confirm({text:_('gallery.album_remove_confirm'),url:this.config.url,params:{action:'mgr/album/remove',id:this.cm.activeNode.attributes.pk},listeners:{'success':{fn:function(r){this.refresh();},scope:this}}});},_handleDrag:function(dropEvent){var encNodes=this.encode();MODx.Ajax.request({url:this.config.url,params:{data:encNodes,action:this.config.sortAction},listeners:{'success':{fn:function(r){this.reloadNode(dropEvent.target.parentNode);},scope:this},'failure':{fn:function(r){MODx.form.Handler.errorJSON(r);return false;},scope:this}}});},_handleDrop:function(e){var target=e.target;var source=e.dropNode;var ap=true;return target.getDepth()<=source.getDepth()&&ap;}});Ext.reg('gal-tree-album',GAL.tree.Album);;GAL.Browser=function(config){if(GAL.browserOpen)return false;GAL.browserOpen=true;config=config||{};Ext.applyIf(config,{onSelect:function(data){},scope:this,cls:'modx-browser'});GAL.Browser.superclass.constructor.call(this,config);this.config=config;this.win=new GAL.BrowserWindow(config);this.win.reset();};Ext.extend(GAL.Browser,Ext.Component,{show:function(el){this.win.show(el);},hide:function(){this.win.hide();}});Ext.reg('gal-browser',GAL.Browser);GAL.BrowserWindow=function(config){config=config||{};this.ident=Ext.id();this.view=MODx.load({xtype:'gal-view-album-items',cls:'modx-pb-view-ct',album:config.album||0,listeners:{'select':{fn:this.onSelect,scope:this}}});this.view.pagingBar=new Ext.PagingToolbar({pageSize:24,store:this.view.store,displayInfo:true,autoLoad:true});this.tree=MODx.load({xtype:'gal-tree-album',scope:this,ident:this.ident,rootVisible:config.rootVisible==null?true:config.rootVisible,listeners:{'click':{fn:function(node,e){this.load(node.attributes.pk);return false;e.stopPropagation();e.preventDefault();},scope:this}},tbar:[]});Ext.applyIf(config,{title:_('gallery.browser'),cls:'modx-pb-win',layout:'border',minWidth:500,minHeight:300,width:'90%',height:500,modal:false,closeAction:'hide',border:false,items:[{id:this.ident+'-browser-tree',cls:'modx-pb-browser-tree',region:'west',width:250,height:'100%',items:this.tree,border:false,autoScroll:true},{id:this.ident+'-browser-view',cls:'modx-pb-view-ct',region:'center',autoScroll:true,width:450,items:this.view,border:false,tbar:this.getToolbar(),bbar:[this.view.pagingBar]},{html:'',id:'gal-album-items-detail',region:'east',split:true,autoScroll:true,width:'20%',minWidth:150,maxWidth:250,height:450,border:false}],buttons:[{id:this.ident+'-ok-btn',text:_('ok'),handler:this.onSelect,scope:this},{text:_('cancel'),handler:this.hide,scope:this}],keys:{key:27,handler:this.hide,scope:this}});GAL.BrowserWindow.superclass.constructor.call(this,config);this.config=config;this.addEvents({'select':true});};Ext.extend(GAL.BrowserWindow,Ext.Window,{returnEl:null,filter:function(){var filter=Ext.getCmp('filter');this.view.store.filter('name',filter.getValue(),true);this.view.select(0);},setReturn:function(el){this.returnEl=el;},load:function(id){this.view.run({album:id});},sortImages:function(){var v=Ext.getCmp('sortSelect').getValue();this.view.store.sort(v,v=='name'?'asc':'desc');this.view.select(0);},reset:function(){if(this.rendered){Ext.getCmp('filter').reset();this.view.getEl().dom.scrollTop=0;}
this.view.store.clearFilter();this.view.select(0);},getToolbar:function(){return[{text:_('filter')+':'},{xtype:'textfield',id:'filter',selectOnFocus:true,width:100,listeners:{'render':{fn:function(){Ext.getCmp('filter').getEl().on('keyup',function(){this.filter();},this,{buffer:500});},scope:this}}},' ','-',{text:_('sort_by')+':'},{id:'sortSelect',xtype:'combo',typeAhead:true,triggerAction:'all',width:100,editable:false,mode:'local',displayField:'desc',valueField:'name',lazyInit:false,value:'name',store:new Ext.data.SimpleStore({fields:['name','desc'],data:[['name',_('name')],['createdon',_('createdon')],['rank',_('rank')]]}),listeners:{'select':{fn:this.sortImages,scope:this}}},'-',{icon:MODx.config.template_url+'images/restyle/icons/refresh.png',cls:'x-btn-icon',tooltip:{text:_('tree_refresh')},handler:this.load,scope:this}];},onSelect:function(data){var selNode=this.view.getSelectedNodes()[0];var callback=this.config.onSelect||this.onSelectHandler;var lookup=this.view.lookup;var scope=this.config.scope;this.hide(this.config.animEl||null,function(){if(selNode&&callback){var data=lookup[selNode.id];Ext.callback(callback,scope||this,[data]);this.fireEvent('select',data);if(window.top.opener){window.top.close();window.top.opener.focus();}}},scope);},onSelectHandler:function(data){Ext.get(this.returnEl).dom.value=unescape(data.url);}});Ext.reg('gal-browser-window',GAL.BrowserWindow);;Ext.override(Ext.slider.Thumb,{onDrag:function(e){var slider=this.slider,index=this.index,newValue=this.getNewValue();if(this.constrain){var above=slider.thumbs[index+1],below=slider.thumbs[index-1];if(below!=undefined&&newValue<=below.value)newValue=below.value;if(above!=undefined&&newValue>=above.value)newValue=above.value;}
slider.setValue(index,newValue,false);slider.fireEvent('drag',slider,e,this);}});GAL.TV=function(config){config=config||{};config.data=config.data||{gal_src:false};this.previewTpl=new Ext.XTemplate('<tpl for=".">','<tpl if="gal_src">','<img src="'+GAL.config.connector_url+'?action=web/phpthumb&src={gal_src}&h={gal_image_height}&w={gal_image_width}&zc=0&far=C&fltr[]=rot|{gal_rotate}&{gal_other}" ',' alt="{gal_name}" class="{gal_class}" id="tv'+config.tv+'-image" style="width: {gal_image_width}px; height: {gal_image_height}px" />','</tpl>','</tpl>');this.previewTpl.compile();var item=this.previewTpl.applyTemplate(config.data);Ext.applyIf(config,{layout:'column',autoHeight:true,labelWidth:160,maxHeight:400,autoScroll:true,border:false,width:Ext.getCmp('modx-panel-resource').getWidth()-300,defaults:{border:false},forceLayout:true,renderTo:'tv'+config.tv+'-form',items:[{columnWidth:.4,bodyStyle:'padding: 10px;',border:false,items:[{layout:'column',border:false,items:[{columnWidth:.5,border:false,items:[{xtype:'button',text:_('gallery.choose_item'),tv:config.tv,handler:this.loadBrowser,scope:this}]},{columnWidth:.5,border:false,items:[{xtype:'button',text:_('gallery.clear_image'),tv:config.tv,handler:this.clearValues,scope:this}]}]},{html:'<br />',border:false},{id:'tv'+config.tv+'-preview-ct',html:'<div class="gal_tv-preview x-panel-body x-panel-body-noheader x-panel-body-noborder" id="tv'+config.tv+'-image-panel" style="height: auto; overflow: auto;">'
+'<div class="gal-crop-wrapper" id="tv'+config.tv+'-crop-wrapper" style="overflow: visible; width: '+config.data['gal_image_width']+'px; height: '+config.data['gal_image_height']+'px; position: absolute;"></div>'
+'<div id="tv'+config.tv+'-preview" style="height: auto; overflow: visible;">'+item+'</div>'
+'</div>',border:false,autoScroll:true,autoHeight:true}]},{columnWidth:.6,layout:'form',bodyStyle:'padding: 45px 10px 10px;',border:false,items:[{xtype:'hidden',name:'gal_id',id:'tv'+config.tv+'-gal_id',value:config.data['gal_id']||0},{xtype:'hidden',name:'gal_album',id:'tv'+config.tv+'-gal_album',value:config.data['gal_album']||0},{xtype:'hidden',name:'gal_src',id:'tv'+config.tv+'-gal_src',value:config.data['gal_src']||''},{xtype:'hidden',name:'orig_width',id:'tv'+config.tv+'-gal_orig_width',value:config.data['gal_orig_width']||0,listeners:{'change':this.syncHidden,scope:this}},{xtype:'hidden',name:'gal_orig_height',id:'tv'+config.tv+'-gal_orig_height',value:config.data['gal_orig_height']||0,listeners:{'change':this.syncHidden,scope:this}},{xtype:'textfield',name:'gal_name',id:'tv'+config.tv+'-gal_name',fieldLabel:_('gallery.title'),value:config.data['gal_name']||'',anchor:'97%',listeners:{'change':this.syncHidden,scope:this}},{xtype:'textfield',name:'gal_description',id:'tv'+config.tv+'-gal_description',fieldLabel:_('gallery.alt_text'),value:config.data['gal_description']||'',anchor:'97%',listeners:{'change':this.syncHidden,scope:this}},{xtype:'textfield',name:'gal_class',id:'tv'+config.tv+'-gal_class',fieldLabel:_('gallery.class'),value:config.data['gal_class']||'',anchor:'97%',listeners:{'change':this.syncHidden,scope:this}},{xtype:'textfield',name:'gal_image_width',id:'tv'+config.tv+'-gal_image_width',fieldLabel:_('gallery.width'),value:config.data['gal_image_width']||0,anchor:'97%',listeners:{'change':this.syncHidden,scope:this}},{xtype:'textfield',name:'gal_image_height',id:'tv'+config.tv+'-gal_image_height',fieldLabel:_('gallery.height'),value:config.data['gal_image_height']||0,anchor:'97%',listeners:{'change':this.syncHidden,scope:this}},{xtype:'slider',id:'tv'+config.tv+'-gal_sizer',fieldLabel:_('gallery.resize'),name:'gal_sizer',minValue:5,maxValue:100,value:config.data['gal_sizer']||100,anchor:'97%',listeners:{'changecomplete':{fn:function(sl,e){this.resetCropValues();this.disableCrop();this.resizeImage(sl,e,'gal_sizer');},scope:this}},plugins:[new Ext.slider.Tip({getText:function(thumb){return String.format('<b>{0}%</b>',thumb.value);}})]},{xtype:'radiogroup',id:'tv'+config.tv+'-gal_rotate',fieldLabel:_('gallery.rotate'),name:'gal_rotate',items:[{boxLabel:'0',name:'gal_rotate',inputValue:0,value:0,checked:config.data['gal_rotate']==0},{boxLabel:'90',name:'gal_rotate',inputValue:90,value:90,checked:config.data['gal_rotate']==90},{boxLabel:'180',name:'gal_rotate',inputValue:180,value:180,checked:config.data['gal_rotate']==180},{boxLabel:'270',name:'gal_rotate',inputValue:270,value:270,checked:config.data['gal_rotate']==270}],allowBlank:false,value:config.data['gal_rotate']||0,anchor:'97%',listeners:{'change':this.syncHidden,scope:this}},{xtype:'textfield',id:'tv'+config.tv+'-gal_other',name:'gal_other',fieldLabel:_('gallery.other_opt'),description:_('gallery.other_opt_desc'),value:config.data['gal_other']||'',anchor:'97%',listeners:{'change':this.syncHidden,scope:this}},{xtype:'fieldset',collapsible:true,collapsed:true,autoHeight:true,title:_('gallery.watermark_options'),items:[{html:'<p>'+_('gallery.watermark_options_desc')+'</p>',border:false},{xtype:'textfield',id:'tv'+config.tv+'-gal_watermark-text',fieldLabel:_('gallery.watermark_text'),description:_('gallery.watermark_text_desc'),name:'gal_watermark-text',allowBlank:true,anchor:'97%',value:config.data['gal_watermark-text']||'',listeners:{'change':this.syncHidden,scope:this}},{xtype:'combo',id:'tv'+config.tv+'-gal_watermark-text-position',fieldLabel:_('gallery.watermark_text_position'),store:[['BR',_('gallery.pos_br')],['BL',_('gallery.pos_bl')],['TR',_('gallery.pos_tr')],['TL',_('gallery.pos_tl')],['C',_('gallery.pos_c')],['R',_('gallery.pos_r')],['L',_('gallery.pos_l')],['T',_('gallery.pos_t')],['B',_('gallery.pos_b')]],description:_('gallery.watermark_text_position_desc'),name:'gal_watermark-text-position',allowBlank:true,anchor:'97%',typeAhead:false,forceSelection:true,triggerAction:'all',selectOnFocus:true,editable:false,value:config.data['gal_watermark-text-position']||'',listeners:{'select':this.syncHidden,scope:this}}]},{xtype:'fieldset',collapsible:false,collapsed:true,checkboxToggle:true,autoHeight:true,title:_('gallery.crop_enable'),id:'tv'+config.tv+'-gal_cropMode',checkboxName:'gal_cropMode',onCheckClick:this.loadCropMode.createDelegate(this),items:[{xtype:'hidden',name:'gal_cropCoords',anchor:'97%',id:'tv'+config.tv+'-gal_cropCoords',value:config.data['gal_cropCoords']?Ext.encode(config.data['gal_cropCoords']):'{}'},{xtype:'statictextfield',name:'gal_cropTop',id:'tv'+config.tv+'-gal_cropTop',fieldLabel:_('gallery.crop_top'),value:config.data['gal_cropTop']||0,allowBlank:true,anchor:'97%',submitValue:true},{xtype:'statictextfield',name:'gal_cropRight',id:'tv'+config.tv+'-gal_cropRight',fieldLabel:_('gallery.crop_right'),value:config.data['gal_cropRight']||0,allowBlank:true,anchor:'97%',submitValue:true},{xtype:'statictextfield',name:'gal_cropBottom',id:'tv'+config.tv+'-gal_cropBottom',fieldLabel:_('gallery.crop_bottom'),value:config.data['gal_cropBottom']||0,allowBlank:true,anchor:'97%',submitValue:true},{xtype:'statictextfield',name:'gal_cropLeft',id:'tv'+config.tv+'-gal_cropLeft',fieldLabel:_('gallery.crop_left'),value:config.data['gal_cropLeft']||0,allowBlank:true,anchor:'97%',submitValue:true}]},{html:'&nbsp;',border:false}]}]});GAL.TV.superclass.constructor.call(this,config);this.setValues(config.data);if(config.data['gal_cropCoords']&&config.data['gal_cropCoords']!='{}'){this.enableCrop();}};Ext.extend(GAL.TV,MODx.Panel,{browser:null,inCropMode:false,fields:['gal_id','gal_album','gal_src','gal_orig_width','gal_orig_height','gal_name','gal_description','gal_class','gal_image_width','gal_image_height','gal_slider','gal_rotate','gal_watermark-text','gal_watermark-text-position','gal_other','gal_cropCoords','gal_cropTop','gal_cropRight','gal_cropBottom','gal_cropLeft','gal_cropMode'],setValues:function(vs){var id;for(id in vs){this.setValue(id,vs[id]);}
return this;},setValue:function(k,v){var f=this.findField(k);if(f&&f.setValue){var vs={};vs[k]=v;this.setHiddenField(vs);return f.setValue(v);}
return false;},getValue:function(k){var v;var f=this.findField(k);if(f&&f.getValue){v=f.getValue();if(Ext.isObject(v)){v=v.value;}
return v;}
return null;},getValues:function(){var f,i,v;var vs={};for(i=0;i<this.fields.length;i++){vs[this.fields[i]]=this.getValue(this.fields[i]);}
return vs;},findField:function(k){var f=Ext.getCmp('tv'+this.config.tv+'-'+k);return f?f:null;},loadCropMode:function(v,b,c){var el=Ext.get(b);if(el&&el.dom&&el.dom.checked){this.enableCrop();}else{this.disableCrop();}},disableCrop:function(){if(this.resizable){this.resizable.el.hide();}
var fld=this.findField('gal_cropMode').collapse();this.resetCropValues();},enableCrop:function(){this.findField('gal_cropMode').expand();this.loadCropper();var img=Ext.get('tv'+this.config.tv+'-image');this.imageBox=img.getBox();},loadCropper:function(){if(this.inCropMode){this.resizable.el.show();var cd=this.getValues();this.resizable.resize4(cd['gal_cropTop'],cd['gal_cropRight'],cd['gal_cropBottom'],cd['gal_cropLeft']);return;}
var cw=Ext.get('tv'+this.config.tv+'-crop-wrapper');var img=Ext.get('tv'+this.config.tv+'-image');this.imageBox=img.getBox();this.resizable=new Ext.Resizable(cw,{wrap:true,minWidth:0,minHeight:0,dynamic:false,transparent:false,handles:'all',draggable:false,pinned:false,style:'overflow: visible;',constrainTo:'tv'+this.config.tv+'-image',resize4:function(t,r,b,l){var imgBox=Ext.get('tv'+this.tv+'-image').getBox();var w=imgBox.width-(parseInt(r)+parseInt(l));var h=imgBox.height-(parseInt(b)+parseInt(t));this.el.setBox({x:imgBox.x+parseInt(l),y:imgBox.y+parseInt(t),width:w,height:h},false,true);this.updateChildSize();},tv:this.config.tv,imgBox:this.imageBox,img:Ext.get('tv'+this.config.tv+'-image')});if(!this.inCropMode){var d=this.getValues();this.resizable.resize4(d['gal_cropTop'],d['gal_cropRight'],d['gal_cropBottom'],d['gal_cropLeft']);}
this.resizable.on('resize',this.onCrop,this);this.resizable.getEl().setStyle('border','1px solid black');cw.select("div[id]").each(function(div){if(div.hasClass("x-resizable-handle"))div.setOpacity(.75);});this.inCropMode=true;},onCrop:function(res){var cropBox=res.el.getBox();var imageBox=Ext.get('tv'+this.config.tv+'-image').getBox();var x1=cropBox.x-imageBox.x;var y1=cropBox.y-imageBox.y;var x2=x1+cropBox.width;var y2=y1+cropBox.height;var rr=imageBox.width-x2;var rb=imageBox.height-y2;this.cropCoords={left:x1>0?x1:0,right:x2>0?x2:0,top:y1>0?y1:0,bottom:y2>0?y2:0,relRight:rr>0?rr:0,relBottom:rb>0?rb:0,on:true};var vs={'gal_cropCoords':Ext.encode(this.cropCoords),'gal_cropTop':this.cropCoords.top,'gal_cropRight':this.cropCoords.relRight,'gal_cropBottom':this.cropCoords.relBottom,'gal_cropLeft':this.cropCoords.left};this.setValues(vs);},resetCropValues:function(){this.setValue('gal_cropCoords','');this.setValue('gal_cropTop',0);this.setValue('gal_cropRight',0);this.setValue('gal_cropBottom',0);this.setValue('gal_cropLeft',0);},syncHidden:function(tf,nv,nm){var v=tf.getValue();if(typeof v!='number'&&typeof v!='boolean'&&typeof v!='object'){v=v.replace("'",'&apos;');}else if(typeof v=='object'){v=v.value;}
var n=tf.getName?tf.getName():nm;this.setValue(n,v+'');this.updateImage();},resizeImage:function(sl,e,name){var nv=this.getValue(name);var w=this.getValue('gal_orig_width');var h=this.getValue('gal_orig_height');var nw=Ext.util.Format.round(w*(nv/100),0);var nh=Ext.util.Format.round(h*(nv/100),0);if(name=='gal_sizer'){this.setValue('gal_image_width',nw);this.setValue('gal_image_height',nh);this.syncHidden(sl,nv,'gal_sizer');}
this.updateImage();this.resetCropValues();},updateImage:function(){var vs=this.getValues();var p=Ext.get('tv'+this.config.tv+'-preview');if(p){this.previewTpl.overwrite(p,vs);}
this.imageBox=Ext.get('tv'+this.config.tv+'-image').getBox();if(this.resizer){this.resizer.imgBox=this.imageBox;}
return true;},loadBrowser:function(btn,e){var alb=this.config.data['gal_album']||0;if(this.browser===null){this.browser=MODx.load({xtype:'gal-browser',album:alb,rootVisible:this.config.rootVisible||false,listeners:{'select':{fn:this.selectImage,scope:this}}});}
this.browser.win.view.store.setBaseParam('album',alb);this.browser.win.view.store.load();this.browser.show(btn);},selectImage:function(data){data['gal_url']=data.absoluteImage;data['gal_src']=data.absoluteImage;this.fireEvent('select',data);data['gal_id']=data.id;data['gal_name']=data.name;data['gal_description']=data.description;data['gal_image_width']=data.image_width;data['gal_image_height']=data.image_height;data['gal_orig_width']=data.image_width;data['gal_orig_height']=data.image_height;data['gal_album']=data.album;data['gal_watermark-text']='';data['gal_watermark-text-position']='BL';data['gal_other']='';data['gal_rotate']=0;data['gal_sizer']=100;this.setValues(data);this.updateImage();this.disableCrop();},setHiddenField:function(data){var fld=Ext.get('tv'+this.config.tv);var js=Ext.decode(fld.dom.value);js=Ext.apply(js,data);fld.dom.value=Ext.encode(js);Ext.getCmp('modx-panel-resource').markDirty();},clearValues:function(){this.setValues({'gal_id':0,'gal_name':'','gal_description':'','gal_class':'','gal_image_width':0,'gal_image_height':0,'gal_slider':100,'gal_rotate':0,'gal_watermark-text':'','gal_watermark-text-position':'BL','gal_other':'','gal_cropCoords':'','gal_cropTop':0,'gal_cropRight':0,'gal_cropBottom':0,'gal_cropLeft':0,'gal_cropMode':0});this.disableCrop();Ext.getCmp('modx-panel-resource').markDirty();Ext.get('tv'+this.config.tv+'-preview').update('&nbsp;');var fld=Ext.get('tv'+this.config.tv);fld.dom.value=Ext.encode({});}});Ext.reg('gal-panel-tv',GAL.TV);Ext.Spotlight.prototype.createElements=function(){var bd=this.maskEl;this.right=bd.createChild({cls:'x-spotlight'});this.left=bd.createChild({cls:'x-spotlight'});this.top=bd.createChild({cls:'x-spotlight'});this.bottom=bd.createChild({cls:'x-spotlight'});this.all=new Ext.CompositeElement([this.right,this.left,this.top,this.bottom]);};